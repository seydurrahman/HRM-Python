{% extends "base.html" %}
{% block title %}Create Floor{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="card shadow-sm p-4">
    <h4 class="fw-semibold mb-4">
      <i class="fas fa-building me-2 text-primary"></i>
      Create Floor
    </h4>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}

    <form method="POST" id="floorForm">
      {% csrf_token %}
      
      <div class="mb-3">
        <label class="form-label fw-semibold">Floor Name <span class="text-danger">*</span></label>
        <input type="text" name="name" class="form-control" placeholder="Enter floor name" required>
      </div>

      <div class="row">
        <!-- Group Selection -->
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">Select Group <span class="text-danger">*</span></label>
          <select id="group_id" name="group_id" class="form-select" required>
            <option value="">-- Select Group --</option>
            {% for g in groups %}
              <option value="{{ g.id }}">{{ g.name }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Unit Selection -->
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">Select Unit <span class="text-danger">*</span></label>
          <select id="unit_id" name="unit_id" class="form-select" required disabled>
            <option value="">-- First Select Group --</option>
          </select>
        </div>

        <!-- Division Selection -->
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">Select Division <span class="text-danger">*</span></label>
          <select id="division_id" name="division_id" class="form-select" required disabled>
            <option value="">-- First Select Unit --</option>
          </select>
        </div>

        <!-- Department Selection -->
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">Select Department <span class="text-danger">*</span></label>
          <select id="department_id" name="department_id" class="form-select" required disabled>
            <option value="">-- First Select Division --</option>
          </select>
        </div>

        <!-- Section Selection -->
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">Select Section <span class="text-danger">*</span></label>
          <select id="section_id" name="section_id" class="form-select" required disabled>
            <option value="">-- First Select Department --</option>
          </select>
        </div>

        <!-- Subsection Selection -->
        <div class="col-md-6 mb-3">
          <label class="form-label fw-semibold">Select Subsection <span class="text-danger">*</span></label>
          <select id="subsection_id" name="subsection_id" class="form-select" required disabled>
            <option value="">-- First Select Section --</option>
          </select>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">Code</label>
        <input type="text" name="code" class="form-control" placeholder="Enter floor code (optional)">
      </div>

      <div class="form-check mb-4">
        <input type="checkbox" name="is_active" class="form-check-input" id="is_active" checked>
        <label class="form-check-label" for="is_active">Active</label>
      </div>

      <div class="d-flex justify-content-between">
        <button type="submit" class="btn btn-primary px-4">
          <i class="fas fa-save me-1"></i> Create Floor
        </button>
        <a href="{% url 'accounts:floor_list' %}" class="btn btn-outline-secondary">
          <i class="fas fa-list me-1"></i> View Floor List
        </a>
      </div>
    </form>
  </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const groupSelect = document.getElementById('group_id');
    const unitSelect = document.getElementById('unit_id');
    const divisionSelect = document.getElementById('division_id');
    const departmentSelect = document.getElementById('department_id');
    const sectionSelect = document.getElementById('section_id');
    const subsectionSelect = document.getElementById('subsection_id');

    // Group change handler
    groupSelect.addEventListener('change', async function() {
        resetDropdowns('unit');
        const groupId = this.value;
        if (!groupId) return;

        await loadUnits(groupId);
    });

    // Unit change handler
    unitSelect.addEventListener('change', async function() {
        resetDropdowns('division');
        const unitId = this.value;
        if (!unitId) return;

        await loadDivisions(unitId);
    });

    // Division change handler
    divisionSelect.addEventListener('change', async function() {
        resetDropdowns('department');
        const divisionId = this.value;
        if (!divisionId) return;

        await loadDepartments(divisionId);
    });

    // Department change handler
    departmentSelect.addEventListener('change', async function() {
        resetDropdowns('section');
        const departmentId = this.value;
        if (!departmentId) return;

        await loadSections(departmentId);
    });

    // Section change handler
    sectionSelect.addEventListener('change', async function() {
        resetDropdowns('subsection');
        const sectionId = this.value;
        if (!sectionId) return;

        await loadSubsections(sectionId);
    });

    // Helper functions
    async function loadUnits(groupId) {
        try {
            const response = await fetch(`/accounts/ajax/units-by-group/?group_id=${groupId}`);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            populateDropdown(unitSelect, data.units, '-- Select Unit --');
        } catch (error) {
            console.error('Error loading units:', error);
            showError(unitSelect);
        }
    }

    async function loadDivisions(unitId) {
        try {
            const response = await fetch(`/accounts/ajax/divisions-by-unit/?unit_id=${unitId}`);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            populateDropdown(divisionSelect, data.divisions, '-- Select Division --');
        } catch (error) {
            console.error('Error loading divisions:', error);
            showError(divisionSelect);
        }
    }

    async function loadDepartments(divisionId) {
        try {
            const response = await fetch(`/accounts/ajax/departments-by-division/?division_id=${divisionId}`);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            populateDropdown(departmentSelect, data.departments, '-- Select Department --');
        } catch (error) {
            console.error('Error loading departments:', error);
            showError(departmentSelect);
        }
    }

    async function loadSections(departmentId) {
        try {
            const response = await fetch(`/accounts/ajax/sections-by-department/?department_id=${departmentId}`);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            populateDropdown(sectionSelect, data.sections, '-- Select Section --');
        } catch (error) {
            console.error('Error loading sections:', error);
            showError(sectionSelect);
        }
    }

    async function loadSubsections(sectionId) {
        try {
            const response = await fetch(`/accounts/ajax/subsections-by-section/?section_id=${sectionId}`);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            populateDropdown(subsectionSelect, data.subsections, '-- Select Subsection --');
        } catch (error) {
            console.error('Error loading subsections:', error);
            showError(subsectionSelect);
        }
    }

    function resetDropdowns(startFrom) {
        const dropdowns = {
            'unit': unitSelect,
            'division': divisionSelect,
            'department': departmentSelect,
            'section': sectionSelect,
            'subsection': subsectionSelect
        };
        
        let shouldReset = false;
        for (const [key, dropdown] of Object.entries(dropdowns)) {
            if (key === startFrom) shouldReset = true;
            if (shouldReset) {
                dropdown.disabled = true;
                dropdown.innerHTML = `<option value="">-- First Select ${startFrom.charAt(0).toUpperCase() + startFrom.slice(1)} --</option>`;
            }
        }
    }

    function populateDropdown(select, items, defaultText) {
        select.innerHTML = `<option value="">${defaultText}</option>`;
        items.forEach(item => {
            select.add(new Option(item.name, item.id));
        });
        select.disabled = false;
    }

    function showError(select) {
        select.innerHTML = '<option value="">-- Error Loading Data --</option>';
        select.disabled = true;
    }
});
</script>
{% endblock %}
{% endblock %}
{% extends "base.html" %}
{% block title %}Company / Units{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-semibold mb-0"><i class="fas fa-building me-2 text-primary"></i>Company / Units</h4>
    <a href="{% url 'accounts:create_unit' %}" class="btn btn-primary">
      <i class="fas fa-plus me-1"></i> Create Unit
    </a>
  </div>

  <form method="get" class="row g-2 mb-3">
    <div class="col-md-4">
      <input type="text" name="q" value="{{ search_query }}" class="form-control" placeholder="Search by name...">
    </div>
    <div class="col-md-2">
      <button type="submit" class="btn btn-secondary w-100">Search</button>
    </div>
    {% if search_query %}
      <div class="col-md-2">
        <a href="{% url 'accounts:unit_list' %}" class="btn btn-outline-secondary w-100">Reset</a>
      </div>
    {% endif %}
  </form>

  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Name</th>
              <th>Code</th>
              <th>Group</th>
              <th>Active</th>
            </tr>
          </thead>
          <tbody>
            {% for u in units %}
              <tr>
                <td>{{ forloop.counter|add:units.start_index|default:forloop.counter }}</td>
                <td>{{ u.name }}</td>
                <td>{{ u.code|default:"â€”" }}</td>
                <td>{{ u.group.name }}</td>
                <td>
                  <span 
                    class="badge {% if u.is_active %}bg-success{% else %}bg-secondary{% endif %} toggle-status"
                    style="cursor:pointer;"
                    data-id="{{ u.id }}"
                    >
                    {% if u.is_active %}Yes{% else %}No{% endif %}
                    </span>
                </td>
              </tr>
            {% empty %}
              <tr><td colspan="5" class="text-center py-3">No units found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {% if units.has_other_pages %}
  <nav class="mt-3" aria-label="Unit pagination">
    <ul class="pagination justify-content-center">
      {% if units.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ units.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}">Previous</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      {% for p in units.paginator.page_range %}
        <li class="page-item {% if units.number == p %}active{% endif %}">
          <a class="page-link" href="?page={{ p }}{% if search_query %}&q={{ search_query }}{% endif %}">{{ p }}</a>
        </li>
      {% endfor %}

      {% if units.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ units.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}">Next</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.toggle-status').forEach(badge => {
    badge.addEventListener('click', function() {
      const unitId = this.dataset.id;
      fetch(`/accounts/units/${unitId}/toggle/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          if (data.new_status) {
            this.textContent = 'Yes';
            this.classList.remove('bg-secondary');
            this.classList.add('bg-success');
          } else {
            this.textContent = 'No';
            this.classList.remove('bg-success');
            this.classList.add('bg-secondary');
          }
        }
      });
    });
  });
});
</script>

{% endblock %}
